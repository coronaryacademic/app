<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Socrates Beta</title>
    <!-- Favicons: provide 16x16 and 32x32 PNG with cache-busting -->
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%234A90E2'/><circle cx='25' cy='30' r='8' fill='none' stroke='white' stroke-width='3'/><circle cx='75' cy='30' r='8' fill='none' stroke='white' stroke-width='3'/><path d='M25 38 Q25 50 50 65' stroke='white' stroke-width='3' fill='none'/><path d='M75 38 Q75 50 50 65' stroke='white' stroke-width='3' fill='none'/><circle cx='50' cy='65' r='6' fill='white'/></svg>"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%234A90E2'/><circle cx='25' cy='30' r='8' fill='none' stroke='white' stroke-width='3'/><circle cx='75' cy='30' r='8' fill='none' stroke='white' stroke-width='3'/><path d='M25 38 Q25 50 50 65' stroke='white' stroke-width='3' fill='none'/><path d='M75 38 Q75 50 50 65' stroke='white' stroke-width='3' fill='none'/><circle cx='50' cy='65' r='6' fill='white'/></svg>"
    />
    <link
      rel="shortcut icon"
      type="image/png"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%234A90E2'/><circle cx='25' cy='30' r='8' fill='none' stroke='white' stroke-width='3'/><circle cx='75' cy='30' r='8' fill='none' stroke='white' stroke-width='3'/><path d='M25 38 Q25 50 50 65' stroke='white' stroke-width='3' fill='none'/><path d='M75 38 Q75 50 50 65' stroke='white' stroke-width='3' fill='none'/><circle cx='50' cy='65' r='6' fill='white'/></svg>"
    />
    <link rel="stylesheet" href="css/header04.css" />
    <link rel="stylesheet" href="css/Beta.css" />
    <link rel="stylesheet" href="css/theme.css" />
    <link rel="stylesheet" href="css/socrates.css" />
    <link rel="stylesheet" href="css/dashboard.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Baloo+Bhaijaan+2:wght@400..800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/5/w3.css" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
    />

    <script>
      // PE Toggle Function - Global availability for dynamically loaded content
      function togglePESection() {
        const peContent = document.getElementById("pe-content");
        const peToggle = document.getElementById("pe-toggle");
        const peSlider = document.querySelector(".pe-slider");
        const peSliderDot = document.querySelector(".pe-slider-dot");

        if (!peContent || !peToggle) return;

        const isHidden =
          peContent.style.display === "none" || peContent.style.display === "";

        if (isHidden) {
          // Show PE section
          peContent.style.display = "block";
          setTimeout(() => {
            peContent.style.opacity = "1";
            // Initialize PE checkbox UI after accordion setup
            console.log("[PE] Setting up checkbox UI after accordion handlers");

            // Add manual accordion handlers directly
            console.log("[PE] Setting up manual accordion handlers");
            const headers = document.querySelectorAll(".pe-accordion-header");
            console.log(
              "[PE] Found headers for manual binding:",
              headers.length
            );
            headers.forEach((header, i) => {
              // Remove any existing listeners to avoid duplicates
              const newHeader = header.cloneNode(true);
              header.parentNode.replaceChild(newHeader, header);

              newHeader.addEventListener("click", function (e) {
                e.preventDefault();
                e.stopPropagation();
                console.log(
                  "[PE] Manual click on header:",
                  this.textContent.trim()
                );
                const content = this.nextElementSibling;
                if (
                  content &&
                  content.classList.contains("pe-accordion-content")
                ) {
                  const isOpen = content.style.display === "block";
                  content.style.display = isOpen ? "none" : "block";
                  const chev = this.querySelector(".chev");
                  if (chev) chev.textContent = isOpen ? "▸" : "▾";
                  console.log(
                    "[PE] Manual toggle:",
                    isOpen ? "CLOSED" : "OPENED"
                  );
                } else {
                  console.log("[PE] No valid content found for header");
                }
              });
              console.log(
                "[PE] Bound manual handler to header",
                i,
                ":",
                newHeader.textContent.trim()
              );
            });

            // Now initialize checkbox UI
            try {
              initPECheckboxes();
              console.log("[PE] Checkbox UI initialized successfully");
            } catch (e) {
              console.warn("[PE] initPECheckboxes failed", e);
            }
          }, 10);

          // Update switch to ON state
          peToggle.checked = true;
          if (peSlider) {
            peSlider.style.backgroundColor = "#4CAF50";
          }
          if (peSliderDot) {
            peSliderDot.style.transform = "translateX(26px)";
            peSliderDot.style.backgroundColor = "#4CAF50";
          }
        } else {
          // Hide PE section
          peContent.style.opacity = "0";
          setTimeout(() => {
            peContent.style.display = "none";
          }, 500);

          // Update switch to OFF state
          peToggle.checked = false;
          if (peSlider) {
            peSlider.style.backgroundColor = "#ccc";
          }
          if (peSliderDot) {
            peSliderDot.style.transform = "translateX(0px)";
            peSliderDot.style.backgroundColor = "white";
          }
        }
      }

      // Touch-friendly multi-select for iPad users
      function initTouchMultiSelect() {
        const peSelects = document.querySelectorAll(
          "#pe-content select[multiple]"
        );

        peSelects.forEach((select) => {
          if (select.dataset.touchInitialized) return;
          select.dataset.touchInitialized = "true";

          // Add search functionality that works with touch interface
          const searchInput = select.parentNode.querySelector(".pe-search");
          if (searchInput) {
            searchInput.addEventListener("input", (e) => {
              const searchTerm = e.target.value.toLowerCase();

              // Update the touch interface buttons if they exist
              const wrapper = select.nextElementSibling;
              if (
                wrapper &&
                wrapper.className === "touch-multiselect-wrapper"
              ) {
                const buttons = wrapper.querySelectorAll(
                  ".touch-options-container button"
                );
                buttons.forEach((btn) => {
                  const text = btn.textContent.toLowerCase();
                  const shouldShow =
                    text.includes(searchTerm) || searchTerm === "";
                  btn.style.display = shouldShow ? "block" : "none";
                });
              }

              // Also update native select options for desktop
              const options = select.querySelectorAll("option");
              options.forEach((option) => {
                const text = option.textContent.toLowerCase();
                const shouldShow =
                  text.includes(searchTerm) || searchTerm === "";
                option.style.display = shouldShow ? "block" : "none";
              });
            });
          }

          // Create custom multi-select interface
          const wrapper = document.createElement("div");
          wrapper.className = "touch-multiselect-wrapper";
          wrapper.style.cssText = `
          border: 1px solid var(--all-text);
          border-radius: 6px;
          background: var(--header-bg);
          min-height: 80px;
          max-height: 200px;
          overflow-y: auto;
          padding: 8px;
          margin-top: 5px;
        `;

          const selectedDisplay = document.createElement("div");
          selectedDisplay.className = "selected-items-display";
          selectedDisplay.style.cssText = `
          min-height: 20px;
          font-size: 12px;
          color: var(--all-text);
          opacity: 0.8;
          margin-bottom: 8px;
          font-style: italic;
        `;
          selectedDisplay.textContent =
            "Tap options below to select multiple items";

          const optionsContainer = document.createElement("div");
          optionsContainer.className = "touch-options-container";

          // Convert select options to touch-friendly buttons
          Array.from(select.options).forEach((option) => {
            if (option.disabled) return;

            const optionBtn = document.createElement("button");
            optionBtn.type = "button";
            optionBtn.textContent = option.text;
            optionBtn.dataset.value = option.value;
            optionBtn.style.cssText = `
            display: block;
            width: 100%;
            text-align: left;
            padding: 8px 12px;
            margin: 2px 0;
            border: 1px solid transparent;
            background: transparent;
            color: var(--all-text);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 13px;
          `;

            optionBtn.addEventListener("click", () => {
              option.selected = !option.selected;
              updateTouchSelectDisplay(
                select,
                selectedDisplay,
                optionsContainer
              );

              // Trigger change event for form data management
              select.dispatchEvent(new Event("change", { bubbles: true }));
            });

            optionsContainer.appendChild(optionBtn);
          });

          wrapper.appendChild(selectedDisplay);
          wrapper.appendChild(optionsContainer);

          // Hide original select and insert custom interface
          select.style.display = "none";
          select.parentNode.insertBefore(wrapper, select.nextSibling);

          // Initial display update
          updateTouchSelectDisplay(select, selectedDisplay, optionsContainer);
        });
      }

      function updateTouchSelectDisplay(
        select,
        selectedDisplay,
        optionsContainer
      ) {
        const selectedOptions = Array.from(select.selectedOptions);
        const buttons = optionsContainer.querySelectorAll("button");

        // Update button styles
        buttons.forEach((btn) => {
          const isSelected = selectedOptions.some(
            (opt) => opt.value === btn.dataset.value
          );
          if (isSelected) {
            btn.style.background = "var(--all-text)";
            btn.style.color = "var(--all-text)";
            btn.style.border = "3px solid #87CEEB";
          } else {
            btn.style.background = "transparent";
            btn.style.color = "var(--all-text)";
            btn.style.border = "1px solid transparent";
          }

          // Add hover effect
          btn.onmouseenter = () => {
            if (!isSelected) {
              btn.style.background = "rgba(128, 128, 128, 0.1)";
              btn.style.borderColor = "var(--all-text)";
              btn.style.color = "var(--all-text)";
            }
          };
          btn.onmouseleave = () => {
            if (!isSelected) {
              btn.style.background = "transparent";
              btn.style.border = "1px solid transparent";
              btn.style.color = "var(--all-text)";
            }
          };
        });

        // Update selected items display
        if (selectedOptions.length === 0) {
          selectedDisplay.textContent =
            "Tap options below to select multiple items";
          selectedDisplay.style.fontStyle = "italic";
        } else {
          selectedDisplay.textContent = `Selected: ${selectedOptions
            .map((opt) => opt.text)
            .join(", ")}`;
          selectedDisplay.style.fontStyle = "normal";
        }
      }

      // Convert PE <select multiple> to checkbox groups, keeping original selects hidden and in sync
      function initPECheckboxes() {
        const peRoot = document.getElementById("pe-content");
        if (!peRoot) return;

        const peSelects = peRoot.querySelectorAll(
          "select[multiple][id^='pe-']"
        );
        peSelects.forEach((sel) => {
          // Don't re-run if already checkboxified
          if (sel.dataset.checkboxified === "1") return;

          // If a touch wrapper was created earlier, remove it to avoid double UI
          const maybeWrapper = sel.nextElementSibling;
          if (
            maybeWrapper &&
            maybeWrapper.classList.contains("touch-multiselect-wrapper")
          ) {
            maybeWrapper.remove();
            sel.style.display = "";
          }

          // Section wrapper per select
          const section = document.createElement("div");
          section.className = "pe-section";
          section.style.display = "block";
          section.style.marginTop = "6px";

          // Grid for options inside a group
          const makeGrid = () => {
            const grid = document.createElement("div");
            grid.className = "pe-checkbox-group";
            grid.style.display = "grid";
            grid.style.gridTemplateColumns =
              "repeat(auto-fill, minmax(230px, 1fr))";
            grid.style.gap = "8px 12px";
            grid.style.marginTop = "6px";
            return grid;
          };

          const makeCheckbox = (opt) => {
            const id = `${sel.id}__${opt.value}`;
            const label = document.createElement("label");
            label.style.display = "flex";
            label.style.alignItems = "center";
            label.style.gap = "8px";
            label.style.padding = "6px 8px";
            label.style.border = "1px solid var(--all-text)";
            label.style.borderRadius = "6px";
            label.style.background = "transparent";
            label.style.color = "var(--all-text)";

            const cb = document.createElement("input");
            cb.type = "checkbox";
            cb.name = sel.id + "[]";
            cb.value = opt.value;
            cb.id = id;
            cb.checked = !!opt.selected;
            cb.style.accentColor = "rgb(86, 212, 254)";
            cb.addEventListener("change", () => {
              opt.selected = cb.checked;
              sel.dispatchEvent(new Event("change", { bubbles: true }));
            });

            const text = document.createElement("span");
            text.textContent = opt.textContent.trim();
            text.style.fontSize = "13px";

            label.appendChild(cb);
            label.appendChild(text);
            return label;
          };

          const children = Array.from(sel.children);
          if (children.some((n) => n.tagName === "OPTGROUP")) {
            children.forEach((node) => {
              if (node.tagName === "OPTGROUP") {
                // Container per optgroup
                const og = document.createElement("div");
                og.className = "pe-optgroup";
                og.style.marginTop = "10px";

                const legend = document.createElement("div");
                legend.textContent = node.getAttribute("label") || "";
                legend.style.fontWeight = "700";
                legend.style.fontSize = "13px";
                legend.style.opacity = "0.9";
                legend.style.marginTop = "4px";
                section.appendChild(legend);

                const grid = makeGrid();
                Array.from(node.children).forEach((opt) => {
                  if (opt.tagName === "OPTION" && !opt.disabled) {
                    grid.appendChild(makeCheckbox(opt));
                  }
                });
                og.appendChild(grid);
                section.appendChild(og);
              }
            });
            // Handle any top-level options outside optgroups
            const topLevel = children.filter(
              (n) => n.tagName === "OPTION" && !n.disabled
            );
            if (topLevel.length) {
              const legend = document.createElement("div");
              legend.textContent = "General";
              legend.style.fontWeight = "700";
              legend.style.fontSize = "13px";
              legend.style.opacity = "0.9";
              legend.style.marginTop = "10px";
              section.appendChild(legend);
              const grid = makeGrid();
              topLevel.forEach((opt) => grid.appendChild(makeCheckbox(opt)));
              section.appendChild(grid);
            }
          } else {
            const grid = makeGrid();
            Array.from(sel.options).forEach((opt) => {
              if (!opt.disabled) grid.appendChild(makeCheckbox(opt));
            });
            section.appendChild(grid);
          }

          // Insert the section before the hidden select
          sel.parentNode.insertBefore(section, sel);
          // Hide original select
          sel.style.display = "none";
          sel.dataset.checkboxified = "1";

          // Hook the search input for this select if present
          const search = sel.parentNode.querySelector(
            `.pe-search[data-target='${sel.id}']`
          );
          if (search) {
            search.addEventListener("input", () => {
              const q = search.value.trim().toLowerCase();
              section.querySelectorAll("label").forEach((lab) => {
                const txt = lab.textContent.toLowerCase();
                lab.style.display =
                  q === "" || txt.includes(q) ? "flex" : "none";
              });
            });
          }
        });
      }
    </script>

    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=home"
    />

    <style>
      .arabic-font {
        font-family: "Baloo Bhaijaan 2", Arial, sans-serif;
      }

      .nav-button {
        background-color: transparent;
        border: none;
        cursor: pointer;
        margin-top: 4px;
        margin-left: 5px;
      }

      #icon {
        width: 20px;
        height: 20px;
      }

      #icon rect {
        transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      }

      #icon.active #topBar {
        transform-origin: 50px 26px;
        transform: translateY(21px) rotate(45deg);
      }

      #icon.active #middleBar {
        opacity: 0;
        transform: scale(0);
      }

      #icon.active #bottomBar {
        transform-origin: 50px 74px;
        transform: translateY(-25px) rotate(-45deg);
      }

      .material-symbols-outlined {
        font-variation-settings: "FILL" 1, "wght" 400, "GRAD" 0, "opsz" 24;
      }

      #ai-gh-token::placeholder {
        color: var(--all-text);
      }

      #aiPrompt::placeholder {
        color: var(--all-text);
        opacity: 1; /* removes default faded look */
      }
    </style>

    <script>
      const savedTheme = localStorage.getItem("theme");

      if (savedTheme) {
        document.documentElement.setAttribute("data-theme", savedTheme);
      }
    </script>
  </head>

  <body
    style="
      font-family: Nunito, Arial;
      margin: 0;
      display: flex;
      flex-direction: column;
      height: 100%;
      width: 100%;
      scroll-behavior: smooth;
      overscroll-behavior: none;
      -webkit-overflow-scrolling: touch;
      padding-top: 75px;
    "
  >
    <!-- Mobile Restriction Overlay -->
    <div class="mobile-restriction-overlay">
      <div class="mobile-restriction-content">
        <div class="device-icons">
          <!-- Laptop SVG -->
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path
              d="M20 18c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2H0v2h24v-2h-4zM4 6h16v10H4V6z"
            />
          </svg>
          <!-- Tablet SVG -->
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path
              d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14zm-7-1c.55 0 1-.45 1-1s-.45-1-1-1-1 .45-1 1 .45 1 1 1z"
            />
          </svg>
        </div>
        <h2>Access Restricted</h2>
        <p>
          This application is optimized for larger screens and is only
          accessible on:
        </p>
        <p><strong>• iPad or larger tablets</strong></p>
        <p><strong>• Laptop computers</strong></p>
        <p><strong>• Desktop computers</strong></p>
        <p>Please switch to a device with a larger screen to continue.</p>
      </div>
    </div>
    <header
      class="header-container"
      style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        z-index: 1000;
        background: var(--header-bg);
        backdrop-filter: blur(30px);
        -webkit-backdrop-filter: blur(30px); /* for Safari */
        border-bottom: 1px solid var(--borderbottomdark);
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        padding-top: 18px;
        padding-bottom: 8px;
        height: 70px;
      "
    >
      <div class="left-section">
        <button
          id="bau-history-external-toggle"
          type="button"
          style="
            padding: 10px 12px;
            background: transparent;
            border: none;
            cursor: pointer;
            display: block;
            opacity: 0.7;
            transition: opacity 0.2s;
            z-index: 1002;
            position: relative;
            top: 0px;
            left: 0px;
          "
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="23"
            height="23"
            viewBox="0 0 100 100"
            style="color: var(--all-text)"
          >
            <rect
              x="5"
              y="20"
              width="90"
              height="8"
              rx="1"
              fill="currentColor"
            ></rect>
            <rect
              x="5"
              y="44"
              width="90"
              height="8"
              rx="1"
              fill="currentColor"
            ></rect>
            <rect
              x="5"
              y="68"
              width="90"
              height="8"
              rx="1"
              fill="currentColor"
            ></rect>
          </svg>
        </button>
        <h1
          id="page-title"
          style="
            font-size: 24px;
            position: relative;
            top: -5px;
            left: 5px;
            right: 0;
            text-align: center;
            z-index: 1;
            user-select: none;
            cursor: pointer;
            transition: color 0.2s ease, transform 0.15s ease;
          "
          role="button"
          tabindex="0"
          onclick="window.location.reload();"
          onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();window.location.reload();}"
          onmouseenter="this.style.transform='translateY(-1px) scale(1.02)'; this.style.color='rgb(52, 164, 162)';"
          onmouseleave="this.style.transform=''; this.style.color='';"
        >
          Socrates<sup style="font-size: 12px; margin-left: 5px">Beta</sup>
        </h1>
      </div>

      <div class="right-section">
        <div
          id="auth-buttons"
          class="right-section"
          style="padding-right: 5px"
        ></div>

        <section class="logo-container" style="margin-right: 5.5px">
          <svg
            id="header-home-svg"
            width="25"
            height="25"
            viewBox="0 0 20 20"
            fill="currentColor"
            xmlns="http://www.w3.org/2000/svg"
            class="icon"
            onclick="goHome();"
            onmouseover="this.style.color='var(--accent-color)'; this.style.transform='scale(1.1)'"
            onmouseout="this.style.color='var(--all-text)'; this.style.transform='scale(1)'"
            style="
              cursor: pointer;
              position: relative;
              top: 9px;
              right: 5px;
              transition: color 0.3s, transform 0.2s, opacity 0.3s ease-out;
              color: var(--all-text);
            "
          >
            <path
              d="M2.6687 11.333V8.66699C2.6687 7.74455 2.66841 7.01205 2.71655 6.42285C2.76533 5.82612 2.86699 5.31731 3.10425 4.85156L3.25854 4.57617C3.64272 3.94975 4.19392 3.43995 4.85229 3.10449L5.02905 3.02149C5.44666 2.84233 5.90133 2.75849 6.42358 2.71582C7.01272 2.66769 7.74445 2.66797 8.66675 2.66797H9.16675C9.53393 2.66797 9.83165 2.96586 9.83179 3.33301C9.83179 3.70028 9.53402 3.99805 9.16675 3.99805H8.66675C7.7226 3.99805 7.05438 3.99834 6.53198 4.04102C6.14611 4.07254 5.87277 4.12568 5.65601 4.20313L5.45581 4.28906C5.01645 4.51293 4.64872 4.85345 4.39233 5.27149L4.28979 5.45508C4.16388 5.7022 4.08381 6.01663 4.04175 6.53125C3.99906 7.05373 3.99878 7.7226 3.99878 8.66699V11.333C3.99878 12.2774 3.99906 12.9463 4.04175 13.4688C4.08381 13.9833 4.16389 14.2978 4.28979 14.5449L4.39233 14.7285C4.64871 15.1465 5.01648 15.4871 5.45581 15.7109L5.65601 15.7969C5.87276 15.8743 6.14614 15.9265 6.53198 15.958C7.05439 16.0007 7.72256 16.002 8.66675 16.002H11.3337C12.2779 16.002 12.9461 16.0007 13.4685 15.958C13.9829 15.916 14.2976 15.8367 14.5447 15.7109L14.7292 15.6074C15.147 15.3511 15.4879 14.9841 15.7117 14.5449L15.7976 14.3447C15.8751 14.128 15.9272 13.8546 15.9587 13.4688C16.0014 12.9463 16.0017 12.2774 16.0017 11.333V10.833C16.0018 10.466 16.2997 10.1681 16.6667 10.168C17.0339 10.168 17.3316 10.4659 17.3318 10.833V11.333C17.3318 12.2555 17.3331 12.9879 17.2849 13.5771C17.2422 14.0993 17.1584 14.5541 16.9792 14.9717L16.8962 15.1484C16.5609 15.8066 16.0507 16.3571 15.4246 16.7412L15.1492 16.8955C14.6833 17.1329 14.1739 17.2354 13.5769 17.2842C12.9878 17.3323 12.256 17.332 11.3337 17.332H8.66675C7.74446 17.332 7.01271 17.3323 6.42358 17.2842C5.90135 17.2415 5.44665 17.1577 5.02905 16.9785L4.85229 16.8955C4.19396 16.5601 3.64271 16.0502 3.25854 15.4238L3.10425 15.1484C2.86697 14.6827 2.76534 14.1739 2.71655 13.5771C2.66841 12.9879 2.6687 12.2555 2.6687 11.333ZM13.4646 3.11328C14.4201 2.334 15.8288 2.38969 16.7195 3.28027L16.8865 3.46485C17.6141 4.35685 17.6143 5.64423 16.8865 6.53613L16.7195 6.7207L11.6726 11.7686C11.1373 12.3039 10.4624 12.6746 9.72827 12.8408L9.41089 12.8994L7.59351 13.1582C7.38637 13.1877 7.17701 13.1187 7.02905 12.9707C6.88112 12.8227 6.81199 12.6134 6.84155 12.4063L7.10132 10.5898L7.15991 10.2715C7.3262 9.53749 7.69692 8.86241 8.23218 8.32715L13.2791 3.28027L13.4646 3.11328ZM15.7791 4.2207C15.3753 3.81702 14.7366 3.79124 14.3035 4.14453L14.2195 4.2207L9.17261 9.26856C8.81541 9.62578 8.56774 10.0756 8.45679 10.5654L8.41772 10.7773L8.28296 11.7158L9.22241 11.582L9.43433 11.543C9.92426 11.432 10.3749 11.1844 10.7322 10.8271L15.7791 5.78027L15.8552 5.69629C16.185 5.29194 16.1852 4.708 15.8552 4.30371L15.7791 4.2207Z"
            ></path>
          </svg>
        </section>
      </div>
    </header>

    <!--
    <nav class="side-bar-container">

        <button class="nav-bar" data-page="main" id="nav-bar1">
        Home
      </button>
      <button class="nav-bar active" data-page="bau" id="nav-bar3">Clinical</button>
      <button class="nav-bar" data-page="dashboard" id="nav-bar-dashboard">
        Dashboard
      </button>
      <button class="nav-bar5" data-page="help" id="nav-bar5">Help</button>
      <button class="nav-bar" data-page="library" id="nav-bar2">Library</button>
      <button class="nav-bar" data-page="contact" id="nav-bar4">
        About Us
      </button>
    </nav>

      -->

    <!-- Add this overlay div right after sidebar -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="main" id="mainContainer">
      <div class="loader"></div>
    </div>

    <!-- <footer class="end-margin" style="font-size: 30px">
      <p class="end-margin-text01">2024 - Coronary Academic MCQs.</p>
      
      <p class="end-margin-text03" style="display: block; line-height: 0px">
        This website has been developed by
        <a href="javascript:void(0);" onclick="copyToClipboard()"
          ><span style="font-weight: 900">Mo'men Allala</span></a
        >.
      </p>

       <br />Content shared on this website is intended for educational
        purposes only. All materials are provided free of charge and should
        never be sold or monetized.
        <a href="javascript:void(0);" onclick="copyToClipboard()"
          ><span class="dynamic-hover" style="font-weight: 700"
            >Contact Me</span
          ></a
        >
        Version – Work in Progress, meaning it's not fully ready and may change
        later.  © 2024 Coronary Academic MCQs. All rights reserved. 
    </footer> -->

    <p
      id="copyMessage"
      class="end-margin-text04"
      style="margin-bottom: 10px; margin-top: 20px"
    >
      Telegram Username '@mumenq' copied to clipboard!
    </p>
    <footer
      class="footer-bar"
      style="
        font-family: Nunito, Arial, sans-serif;
        width: 100%;
        color: var(--text-color);
        text-align: center;
        padding: 5px 15px;
        font-size: 13px;
        margin-top: 5px;
        position: relative; /* make footer a positioning container */
      "
    >
      <button id="backToTopBtn" class="back-to-top" title="Back to the top">
        <i style="font-size: 15px; color: var(--lang-txt)" class="fas"
          >&#xf062;</i
        >
      </button>

      <span
        data-role="app-version"
        style="font-size: 10px; text-align: center; z-index: 9999"
      >
        Fetching version update..
      </span>
    </footer>

    <script>
      function loadScript(src) {
        return new Promise((resolve, reject) => {
          if (document.querySelector(`script[src="${src}"]`)) {
            resolve();
            return;
          }
          const script = document.createElement("script");
          script.src = src;
          script.onload = () => resolve();
          script.onerror = () =>
            reject(new Error(`Failed to load script: ${src}`));
          document.body.appendChild(script);
        });
      }
    </script>

    <!-- Load jsPDF globally, before your dynamic JS loads -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-arabic/dist/jspdf-arabic.umd.min.js"></script>
    <script src="script.js" defer></script>
    <script src="theme.js"></script>

    <script
      src="https://kit.fontawesome.com/607f9f57fe.js"
      crossorigin="anonymous"
    ></script>

    <script>
      function copyToClipboard() {
        const textToCopy = "@mumenq";
        const textarea = document.createElement("textarea");
        textarea.value = textToCopy;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand("copy");
        document.body.removeChild(textarea);

        const message = document.getElementById("copyMessage");

        // Reset classes before showing
        message.classList.remove("show", "hide");
        message.style.visibility = "visible"; // Ensure it's visible before showing

        // Show message
        message.classList.add("show");

        // Remove the message after 2 seconds with smooth transition
        setTimeout(function () {
          message.classList.add("hide");
          message.classList.remove("show");
        }, 2000);

        // Ensure visibility is hidden after the transition ends
        setTimeout(function () {
          message.style.visibility = "hidden";
        }, 2500); // Wait for the complete transition duration before hiding
      }
    </script>

    <script type="module">
      console.log("[INDEX] Debug script running");

      const authButtonsDiv = document.getElementById("auth-buttons");
      if (authButtonsDiv) {
        console.log("[INDEX] Found auth-buttons div:", authButtonsDiv);
      } else {
        console.warn("[INDEX] auth-buttons div NOT found!");
      }

      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";

      // Add Firestore imports **here** inside the same module script:
      import {
        getFirestore,
        collection,
        addDoc,
        serverTimestamp,
        query,
        orderBy,
        limit,
        getDocs,
        doc,
        getDoc,
        setDoc,
        updateDoc,
        onSnapshot,
        deleteDoc,
      } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

      // Firebase App Check (reCAPTCHA v3)
      import {
        initializeAppCheck,
        ReCaptchaV3Provider,
      } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app-check.js";

      // Firebase AI Logic imports
      import {
        getAI,
        getGenerativeModel,
        GoogleAIBackend,
      } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-ai.js";

      const firebaseConfig = {
        apiKey: "AIzaSyB6e_H-E7l6_x9GbOeJONZ515lsclyoogw",
        authDomain: "coronary-64f63.firebaseapp.com",
        projectId: "coronary-64f63",
        storageBucket: "coronary-64f63.firebasestorage.app",
        messagingSenderId: "110121771753",
        appId: "1:110121771753:web:bad6365385b0a38fa94678",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);

      // Initialize App Check
      try {
        initializeAppCheck(app, {
          provider: new ReCaptchaV3Provider(
            "6LfG0K4rAAAAAF3KHHvWhBhnzakAXIRBsOXgiOsM"
          ),
          isTokenAutoRefreshEnabled: true,
        });
        console.log("[INDEX] Firebase App Check initialized");
      } catch (e) {
        console.warn("[INDEX] App Check init failed or unavailable:", e);
      }

      // Initialize Firestore
      const db = getFirestore(app);

      // Initialize Firebase AI Logic with App Check
      let ai;
      try {
        ai = getAI(app, { backend: new GoogleAIBackend() });
        console.log("[INDEX] Firebase AI Logic initialized successfully");
      } catch (error) {
        console.error(
          "[INDEX] Firebase AI Logic initialization failed:",
          error
        );
      }

      // Expose these globally if you want to access from other scripts
      window.firebaseApp = app;
      window.auth = auth;
      window.onAuthStateChanged = onAuthStateChanged;
      window.signOut = signOut;
      window.firebaseAI = ai;
      window.getGenerativeModel = getGenerativeModel;
      window.GoogleAIBackend = GoogleAIBackend;

      window.db = db;
      window.getDocs = getDocs;
      window.collection = collection;
      window.addDoc = addDoc;
      window.query = query;
      window.orderBy = orderBy;
      window.limit = limit;
      window.doc = doc;
      window.getDoc = getDoc;
      window.setDoc = setDoc;
      window.updateDoc = updateDoc;
      window.onSnapshot = onSnapshot;
      window.deleteDoc = deleteDoc;
      window.serverTimestamp = serverTimestamp;

      window.firebaseApp = app;
      window.auth = auth;
      window.onAuthStateChanged = onAuthStateChanged;
      window.signOut = signOut;

      // Helper to dynamically load dashboard.js as a module and cache it
      async function loadDashboardScript() {
        try {
          if (!sessionStorage.getItem("dashboardScriptLoaded")) {
            console.log("[INDEX] Fetching and loading dashboard.js...");
            // Fetch dashboard.js text
            const response = await fetch("cont/00.dashboard/dashboard.js");
            if (!response.ok) throw new Error("Failed to fetch dashboard.js");
            const jsText = await response.text();

            // Create a new script element and evaluate the JS code as a module
            const blob = new Blob([jsText], { type: "text/javascript" });
            const url = URL.createObjectURL(blob);
            await import(url);
            URL.revokeObjectURL(url);

            sessionStorage.setItem("dashboardScriptLoaded", "true");
            console.log("[INDEX] dashboard.js loaded and applied successfully");
          } else {
            console.log(
              "[INDEX] dashboard.js already loaded from sessionStorage"
            );
          }
        } catch (error) {
          console.error("[INDEX] Error loading dashboard.js:", error);
        }
      }

      async function loadDashboard() {
        const mainContainer = document.querySelector(".main");
        if (!mainContainer) {
          console.error("[INDEX] Main container not found");
          return;
        }

        try {
          const response = await fetch("cont/00.dashboard/dashboard.html");
          if (!response.ok) throw new Error("Failed to load dashboard.html");
          const html = await response.text();

          mainContainer.innerHTML = html;
          console.log("[INDEX] Dashboard HTML loaded successfully");

          if (typeof window.initDashboard === "function") {
            window.initDashboard();
            console.log("[INDEX] initDashboard() called");
          }

          // Trigger animation after initDashboard
          if (typeof window.animateDashboardActiveSection === "function") {
            window.animateDashboardActiveSection();
            console.log("[INDEX] animateDashboardActiveSection() called");
          }

          sessionStorage.setItem("currentPage", "dashboard");
          if (typeof window.setHeaderTitleByPage === "function") {
            window.setHeaderTitleByPage("dashboard");
          }
          // Ensure BAU history sidebar exists on dashboard
          try {
            if (typeof window.ensureHistorySidebar === "function") {
              window.ensureHistorySidebar();
            }
          } catch (e) {
            console.warn(
              "[INDEX] ensureHistorySidebar failed or unavailable",
              e
            );
          }
        } catch (err) {
          console.error("[INDEX] Error loading dashboard:", err);
        }
      }

      function loadDefaultPage() {
        return loadContent("bau")
          .then(() => console.log("Default page loaded"))
          .catch((err) => {
            console.error("Failed to load default page:", err);
            const mainContainer = document.querySelector(".main");
            if (mainContainer) {
              mainContainer.innerHTML = `
               <div
                style="
                  min-height: calc(100vh - 120px);
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  padding: 20px;
                "
              >
                <div
                  style="
                    text-align: center;
                    max-width: 560px;
                    color: var(--all-text);
                    background: rgba(150, 150, 150, 0.12);
                    border: 1px solid rgba(150, 150, 150, 0.3);
                    border-radius: 12px;
                    padding: 24px 18px;
                    backdrop-filter: blur(6px);
                    -webkit-backdrop-filter: blur(6px);
                  "
                >
                  <div style="font-size: 20px; font-weight: 600; margin-bottom: 8px">
                    Oops!
                  </div>
                  <div style="font-size: 16px; font-weight: 400">
                    Seems like your connection is weak or disturbed :(<br />
                    If things aren't loading, re-connect to the Wi‑Fi or use mobile data.
                  </div>
                </div>
              </div>
              `;
            }
          });
      }

      function restoreAccountButton() {
        console.log("[INDEX] restoreAccountButton called");
        if (!authButtonsDiv) {
          console.warn(
            "[INDEX] auth-buttons div NOT found in restoreAccountButton"
          );
          return;
        }
        authButtonsDiv.innerHTML = `
      <a href="cont/011215071914/Login.html">
        <button class="login-button" style="margin-right: 10px; margin-top: 11px; display: flex; align-items: center; gap: 8px;">
          Account
          <div style="
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
          ">A</div>
        </button>
      </a>
    `;
        console.log("[INDEX] Account button restored");
      }

      function updateAuthUI(user) {
        console.log("[INDEX] updateAuthUI called with user:", user);
        if (!authButtonsDiv) {
          console.warn("[INDEX] auth-buttons div NOT found in updateAuthUI");
          return;
        }

        if (user) {
          // Hide auth buttons when logged in - user functions now in sidebar
          authButtonsDiv.innerHTML = ``;
        } else {
          console.log("[INDEX] No user logged in, restoring Account button");
          restoreAccountButton();
          loadDefaultPage();
        }
      }

      // Expose functions globally
      window.loadDashboard = loadDashboard;
      window.loadDefaultPage = loadDefaultPage;
      window.restoreAccountButton = restoreAccountButton;
      window.updateNavActiveState = updateNavActiveState;

      window.addEventListener("DOMContentLoaded", () => {
        onAuthStateChanged(auth, (user) => {
          if (user) {
            updateAuthUI(user);

            // Load saved page from sessionStorage or default to bau
            const savedPage = sessionStorage.getItem("currentPage") || "bau";

            if (savedPage === "dashboard") {
              loadDashboard();
            } else {
              loadContent(savedPage).catch((err) => {
                console.error("Failed to load saved page:", err);
                loadDefaultPage();
              });
            }
          } else {
            // Enforce login-first: redirect immediately to login page
            try {
              window.location.href = "cont/011215071914/Login.html";
            } catch (e) {
              console.warn("[INDEX] Redirect to login failed:", e);
            }
          }
        });
      });
    </script>
    <script>
      let lastScrollTop = 0;
      const header = document.querySelector(".header-container");

      // Set a threshold to prevent early hiding near top of the page
      const scrollThreshold = 50;

      window.addEventListener("scroll", function () {
        const scrollTop =
          window.pageYOffset || document.documentElement.scrollTop;

        // Prevent hiding if within the top threshold
        if (scrollTop < scrollThreshold) {
          header.classList.remove("hide-on-scroll");
          header.classList.add("show-on-scroll");
          lastScrollTop = scrollTop;
          return;
        }

        if (scrollTop > lastScrollTop) {
          // Scrolling down
          header.classList.remove("show-on-scroll");
          header.classList.add("hide-on-scroll");
        } else {
          // Scrolling up
          header.classList.remove("hide-on-scroll");
          header.classList.add("show-on-scroll");
        }

        lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;
      });
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const btn = document.getElementById("submit-and-download");
        if (btn) {
          btn.addEventListener("click", () => {
            // Your download or submit logic here
            console.log("Submit & Download button clicked");
            // Example: generate PDF or trigger download
          });
        } else {
          console.warn("submit-and-download button not found");
        }
      });
    </script>
    <script type="module" src="cont/00.dashboard/dashboard.js"></script>

    <script>
      (function () {
        // Inject into main container instead of using a full-page overlay
        const MAIN_SEL = ".main, #mainContainer";
        const FOOTER_ID = "index-offline-footer";
        let savedMainHTML = null;
        let footerInterval = null;

        function nowText() {
          try {
            return new Date().toLocaleString();
          } catch (e) {
            return new Date().toString();
          }
        }

        function getMain() {
          return (
            document.querySelector("#mainContainer") ||
            document.querySelector(".main")
          );
        }

        function showInMain() {
          const main = getMain();
          if (!main) return;
          if (savedMainHTML === null) savedMainHTML = main.innerHTML;

          main.innerHTML = `
            <div style="min-height: calc(100vh - 120px); display: flex; align-items: center; justify-content: center; padding: 20px;">
              <div style="text-align: center; max-width: 560px; color: var(--all-text); background: rgba(150,150,150,0.12); border: 1px solid rgba(150,150,150,0.3); border-radius: 12px; padding: 24px 18px; backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);">
                <div style="font-size: 20px; font-weight: 600; margin-bottom: 8px;">Oops!</div>
                <div style="font-size: 16px; font-weight: 400;">
                  Seems like your connection is weak or disturbed :(<br/>
                  If things aren't loading, re-connect to Wi‑Fi or use mobile data.
                </div>
              </div>
            </div>
            <div id="${FOOTER_ID}" style="position: fixed; left: 0; right: 0; bottom: 0; padding: 8px 12px; font-size: 12px; text-align: center; color: var(--all-text); background: rgba(0,0,0,0.25); backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px); z-index: 1000;">
              Socrates Beta. ${nowText()}. v1.13 LS. v1.20 GS.
            </div>
          `;

          const footer = document.getElementById(FOOTER_ID);
          function renderFooter() {
            if (footer)
              footer.textContent = `Socrates Beta. ${nowText()}. v1.13 LS. v1.20 GS.`;
          }
          renderFooter();
          if (!footerInterval) footerInterval = setInterval(renderFooter, 1000);
        }

        function restoreMain() {
          const main = getMain();
          if (!main) return;
          const footer = document.getElementById(FOOTER_ID);
          if (footer) footer.remove();
          if (footerInterval) {
            clearInterval(footerInterval);
            footerInterval = null;
          }

          // Prefer reloading the current page content to ensure scripts/states are correct
          try {
            const savedPage = sessionStorage.getItem("currentPage") || "bau";
            if (typeof window.loadContent === "function") {
              window.loadContent(savedPage).catch(() => {
                if (typeof window.loadDefaultPage === "function")
                  window.loadDefaultPage();
              });
            } else if (typeof window.loadDefaultPage === "function") {
              window.loadDefaultPage();
            } else if (savedMainHTML !== null) {
              main.innerHTML = savedMainHTML;
            }
          } finally {
            savedMainHTML = null;
          }
        }

        function sync() {
          if (navigator.onLine === false) showInMain();
          else restoreMain();
        }

        window.addEventListener("offline", showInMain);
        window.addEventListener("online", restoreMain);
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", sync);
        } else {
          sync();
        }
      })();
    </script>
  </body>
</html>
